<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Admin ‚Äî CareerTracker</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" />
  <link rel="stylesheet" href="../assets/css/base.css" />
  <link rel="stylesheet" href="../assets/css/layout.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />
  <link rel="stylesheet" href="../assets/css/modal.css" />
  <link rel="stylesheet" href="../assets/css/mobile.css" />
  <link rel="stylesheet" href="../assets/css/theme.css" />
  <script>(function(){ if(localStorage.getItem('theme')==='dark') document.documentElement.setAttribute('data-theme','dark'); })();</script>
  <style>
    .page-content { padding: calc(var(--topbar-h) + 1.25rem) 1.5rem 3rem; max-width: 920px; margin: 0 auto; }
    .back-link { display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; color: var(--brand); font-weight: 600; text-decoration: none; margin-bottom: 1.25rem; }
    .back-link:hover { opacity: 0.8; }
    .page-header { margin-bottom: 1.5rem; }
    .page-header h1 { font-size: 1.5rem; font-weight: 800; color: var(--dark); }
    .page-header p { font-size: 0.85rem; color: var(--muted); margin-top: 0.3rem; }

    .admin-notice {
      display: none;
      background: rgba(244,185,96,0.1);
      border: 1px solid rgba(244,185,96,0.35);
      border-radius: var(--radius-md);
      padding: 0.875rem 1.25rem;
      margin-bottom: 1.25rem;
      font-size: 0.85rem;
      color: #a07020;
      font-weight: 600;
      align-items: center;
      gap: 0.5rem;
    }
    [data-theme="dark"] .admin-notice { color: #f4b960; }

    /* Chat Layout */
    .chat-wrap { display: flex; gap: 1.25rem; height: calc(100vh - var(--topbar-h) - 10rem); min-height: 500px; }

    /* Sidebar */
    .chat-sidebar { width: 270px; flex-shrink: 0; display: flex; flex-direction: column; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
    .sidebar-new { padding: 0.875rem; border-bottom: 1px solid var(--border); }
    .btn-compose { width: 100%; padding: 0.65rem; background: var(--brand); color: white; border: none; border-radius: var(--radius-md); font-size: 0.82rem; font-weight: 700; font-family: "Poppins", sans-serif; cursor: pointer; transition: all 0.2s; }
    .btn-compose:hover { background: var(--brand-dark); }
    .sidebar-title { padding: 0.6rem 1rem; font-size: 0.7rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; background: var(--card-bg); border-bottom: 1px solid var(--border); }
    .conv-list { flex: 1; overflow-y: auto; }
    .conv-item { padding: 0.875rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.15s; display: flex; align-items: flex-start; gap: 0.5rem; }
    .conv-item:hover { background: rgba(92,102,122,0.07); }
    .conv-item.active { background: rgba(92,102,122,0.1); border-left: 3px solid var(--brand); }
    .conv-item-body { flex: 1; min-width: 0; }
    .conv-subject { font-size: 0.82rem; font-weight: 600; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conv-meta { font-size: 0.7rem; color: var(--muted); margin-top: 0.2rem; }
    .unread-dot { width: 8px; height: 8px; background: var(--brand); border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
    .conv-empty { padding: 2rem 1rem; text-align: center; color: var(--muted); font-size: 0.82rem; }

    /* Chat Main */
    .chat-main { flex: 1; display: flex; flex-direction: column; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; min-width: 0; }

    /* Empty State */
    .chat-empty { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); gap: 0.75rem; }
    .chat-empty .ei { font-size: 3rem; }
    .chat-empty p { font-size: 0.9rem; }

    /* Chat View (visible when message selected) */
    .chat-view { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    .chat-view.visible { display: flex; }

    .msg-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); background: var(--card-bg); flex-shrink: 0; }
    .msg-header h3 { font-size: 1rem; font-weight: 700; color: var(--dark); }
    .msg-header .msg-sub { font-size: 0.78rem; color: var(--muted); margin-top: 0.2rem; }

    .msg-thread { flex: 1; overflow-y: auto; padding: 1.25rem; display: flex; flex-direction: column; gap: 1rem; }
    .bubble { max-width: 76%; display: flex; flex-direction: column; }
    .bubble.from-user { align-self: flex-end; align-items: flex-end; }
    .bubble.from-admin { align-self: flex-start; align-items: flex-start; }
    .bubble-name { font-size: 0.73rem; font-weight: 700; margin-bottom: 0.3rem; color: var(--brand); }
    .bubble.from-admin .bubble-name { color: #a07020; }
    .bubble-inner { padding: 0.875rem 1.1rem; border-radius: 1.25rem; font-size: 0.88rem; line-height: 1.6; }
    .bubble.from-user .bubble-inner { background: var(--brand); color: white; border-bottom-right-radius: 0.3rem; }
    .bubble.from-admin .bubble-inner { background: var(--card-bg); border: 1px solid var(--border); color: var(--text); border-bottom-left-radius: 0.3rem; }
    .bubble-time { font-size: 0.68rem; color: var(--muted); margin-top: 0.3rem; }
    .admin-chip { display: inline-block; background: rgba(244,185,96,0.15); border: 1px solid rgba(244,185,96,0.3); color: #a07020; font-size: 0.62rem; font-weight: 700; padding: 1px 6px; border-radius: 2rem; margin-left: 0.4rem; vertical-align: middle; }
    [data-theme="dark"] .admin-chip { color: #f4b960; }

    /* Reply bar */
    .reply-bar { padding: 0.875rem 1.25rem; border-top: 1px solid var(--border); background: var(--card-bg); display: flex; gap: 0.75rem; align-items: flex-end; flex-shrink: 0; }
    .reply-bar textarea { flex: 1; resize: none; border: 1.5px solid var(--border); border-radius: var(--radius-md); padding: 0.6rem 0.875rem; font-size: 0.88rem; font-family: "Poppins", sans-serif; color: var(--text); background: var(--surface); outline: none; min-height: 42px; max-height: 110px; transition: border-color 0.2s; }
    .reply-bar textarea:focus { border-color: var(--brand); }
    .btn-send { padding: 0.6rem 1.1rem; background: var(--brand); color: white; border: none; border-radius: var(--radius-md); font-size: 0.85rem; font-weight: 700; cursor: pointer; font-family: "Poppins", sans-serif; flex-shrink: 0; transition: all 0.2s; }
    .btn-send:hover { background: var(--brand-dark); }
    .btn-send:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Compose modal overlay */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 1rem; }
    .modal-overlay.show { display: flex; }
    .modal-box { background: var(--surface); border-radius: var(--radius-lg); padding: 2rem; width: 100%; max-width: 500px; box-shadow: 0 24px 80px rgba(0,0,0,0.3); }
    .modal-box h3 { font-size: 1.1rem; font-weight: 800; color: var(--dark); margin-bottom: 1.5rem; }
    .mfield { display: flex; flex-direction: column; gap: 0.3rem; margin-bottom: 1rem; }
    .mfield label { font-size: 0.7rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .mfield input, .mfield textarea { padding: 0.7rem 1rem; border: 1.5px solid var(--border); border-radius: var(--radius-md); font-size: 0.9rem; font-family: "Poppins", sans-serif; color: var(--text); background: var(--surface); outline: none; width: 100%; box-sizing: border-box; transition: border-color 0.2s; }
    .mfield input:focus, .mfield textarea:focus { border-color: var(--brand); }
    .mfield textarea { resize: vertical; min-height: 100px; }
    .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.25rem; }
    .btn-cancel-modal { padding: 0.6rem 1.2rem; background: transparent; color: var(--muted); border: 1.5px solid var(--border); border-radius: var(--radius-md); font-size: 0.85rem; font-weight: 600; cursor: pointer; font-family: "Poppins", sans-serif; }
    .btn-send-modal { padding: 0.6rem 1.5rem; background: var(--brand); color: white; border: none; border-radius: var(--radius-md); font-size: 0.85rem; font-weight: 700; cursor: pointer; font-family: "Poppins", sans-serif; }
    .btn-send-modal:hover { background: var(--brand-dark); }

    @media (max-width: 700px) {
      .chat-wrap { flex-direction: column; height: auto; }
      .chat-sidebar { width: 100%; height: 240px; }
      .chat-main { min-height: 400px; }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="left-section">
      <div id="toggleBtn">‚ò∞</div>
      <a href="home.html" class="logo">Career<span>Tracker</span></a>
    </div>
    <div class="right-section">
      <button class="lang-btn" title="Switch language">üá¨üáß EN</button>
      <button id="darkModeToggle" title="Toggle dark mode">üåô</button>
      <div class="profile" id="profileBtn">
        <span id="topbarDisplayName">-</span>
        <div class="avatar" id="topbarAvatar"></div>
      </div>
    </div>
  </header>
  <aside class="sidebar" id="sidebar">
    <div class="menu">
      <a href="home.html" class="menu-item">üè† <span data-i18n="nav_home">Home</span></a>
      <a href="how-to-use.html" class="menu-item">üìñ <span data-i18n="nav_how_to_use">How to Use</span></a>
      <a href="about.html" class="menu-item active">‚ÑπÔ∏è <span data-i18n="nav_about">About</span></a>        <div id="adminMenu" style="display:none">
          <div class="admin-menu-label">Admin Panel</div>
          <a href="contact-email.html"   class="menu-item admin-item">‚úâÔ∏è <span>Messages</span></a>
          <a href="contact-bug.html"     class="menu-item admin-item">üêõ <span>Bug Reports</span></a>
          <a href="contact-feature.html" class="menu-item admin-item">üí° <span>Feature Requests</span></a>
        </div>
      </div>
  </aside>
  <div id="sidebarOverlay"></div>
  <div class="profile-dropdown" id="dropdown">
    <div data-i18n="nav_profile">üë§ Profile</div>
    <div id="cvLink" data-i18n="nav_my_cv">üìÑ My CV</div>
    <div id="contactLink" data-i18n="nav_contact">üí¨ Contact Us</div>
    <hr />
    <div class="logout" data-i18n="nav_sign_out">üö™ Sign Out</div>
  </div>

  <main class="main" id="main">
    <div class="page-content">
      <a href="about.html" class="back-link">‚Üê <span data-i18n="nav_about">About</span></a>
      <div class="page-header">
        <h1>‚úâÔ∏è <span data-i18n="email_title">Email Admin</span></h1>
        <p data-i18n="email_subtitle">Kirim pesan, pertanyaan, atau saran. Admin akan membalas langsung di sini.</p>
      </div>

      <div class="admin-notice" id="adminNotice">
        <span data-i18n="admin_mode_msg">üëë Admin Mode ‚Äî melihat semua pesan pengguna dan dapat membalasnya.</span>
      </div>

      <div class="chat-wrap">
        <!-- Sidebar -->
        <div class="chat-sidebar">
          <div class="sidebar-new">
            <button class="btn-compose" id="newMsgBtn">‚úâÔ∏è New Message</button>
          </div>
          <div class="sidebar-title" id="inboxLabel">My Messages</div>
          <div class="conv-list" id="convList">
            <div class="conv-empty">Loading...</div>
          </div>
        </div>

        <!-- Main -->
        <div class="chat-main">
          <div class="chat-empty" id="chatEmpty">
            <div class="ei">‚úâÔ∏è</div>
            <p data-i18n="email_select_msg">Pilih pesan atau mulai pesan baru</p>
          </div>
          <div class="chat-view" id="chatView">
            <div class="msg-header">
              <h3 id="msgSubject">‚Äî</h3>
              <div class="msg-sub" id="msgMeta"></div>
            </div>
            <div class="msg-thread" id="msgThread"></div>
            <div class="reply-bar" id="replyBar" style="display:none">
              <textarea id="replyInput" placeholder="Tulis balasan Anda..." rows="2"></textarea>
              <button class="btn-send" id="sendReplyBtn">‚Üë Reply</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Compose Modal -->
  <div class="modal-overlay" id="composeModal">
    <div class="modal-box">
      <h3>‚úâÔ∏è <span data-i18n="email_compose_title">Pesan Baru ke Admin</span></h3>
      <div class="mfield">
        <label>Subject</label>
        <input type="text" id="composeSubject" placeholder="Subjek pesan..." />
      </div>
      <div class="mfield">
        <label>Message</label>
        <textarea id="composeBody" placeholder="Tulis pesan Anda..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel-modal" id="cancelCompose">Cancel</button>
        <button class="btn-send-modal" id="sendCompose">‚úâÔ∏è Send</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="../assets/js/darkMode.js"></script>
  <script src="../assets/js/supabaseClient.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/ui.js"></script>
  <script src="../assets/js/i18n.js"></script>
  <script src="../assets/js/main.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const db = window.supabaseClient;
      const username = localStorage.getItem("currentUser");
      const isAdmin = username === "admin";
      let selectedId = null;
      // Admin setup
      if (isAdmin) {
        document.getElementById("adminNotice").style.display = "flex";
        document.getElementById("inboxLabel").textContent = "Semua Pesan Pengguna";
        document.getElementById("replyBar").style.display = "flex";
        document.getElementById("newMsgBtn").style.display = "none";
      }

      function fmtDate(d) {
        const dt = new Date(d);
        return dt.toLocaleDateString("en-US",{month:"short",day:"numeric"}) + " " + dt.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});
      }

      async function loadConversations() {
        let q = db.from("messages").select("*").order("created_at",{ascending:false});
        if (!isAdmin) q = q.eq("from_username", username);
        const { data, error } = await q;
        const list = document.getElementById("convList");
        if (error) {
          // RLS policy may restrict access - show friendly message instead of raw error
          const isRLS = error.message && (error.message.includes("permission") || error.message.includes("policy") || error.message.includes("denied"));
          if (isRLS && isAdmin) {
            list.innerHTML = `<div class="conv-empty">‚ö†Ô∏è Supabase RLS aktif.<br><small>Tambahkan policy untuk admin di tabel messages.</small></div>`;
          } else if (isRLS) {
            list.innerHTML = '<div class="conv-empty">Belum ada pesan.</div>';
          } else {
            list.innerHTML = '<div class="conv-empty">Gagal memuat pesan.</div>';
          }
          return;
        }
        if (!data || data.length === 0) {
          list.innerHTML = '<div class="conv-empty">No messages yet.</div>';
          return;
        }
        list.innerHTML = data.map(m => `
          <div class="conv-item${m.id===selectedId?' active':''}" data-id="${m.id}">
            <div class="conv-item-body">
              <div class="conv-subject">${escHtml(m.subject)}</div>
              <div class="conv-meta">${isAdmin?'üë§ '+m.from_username+' ¬∑ ':''}${fmtDate(m.created_at)}</div>
            </div>
            ${isAdmin && !m.replied ? '<div class="unread-dot" title="Awaiting reply"></div>' : ''}
          </div>`).join("");
        list.querySelectorAll(".conv-item").forEach(el => {
          el.addEventListener("click", () => {
            const row = data.find(m => m.id === el.dataset.id);
            if (row) openMsg(row);
          });
        });
      }

      function openMsg(m) {
        selectedId = m.id;
        document.getElementById("chatEmpty").style.display = "none";
        const cv = document.getElementById("chatView");
        cv.classList.add("visible");

        document.getElementById("msgSubject").textContent = m.subject;
        document.getElementById("msgMeta").textContent =
          (isAdmin ? "From: " + m.from_username + " ¬∑ " : "Sent ¬∑ ") + fmtDate(m.created_at);

        const thread = document.getElementById("msgThread");
        let html = `
          <div class="bubble from-user">
            <div class="bubble-name">${isAdmin ? escHtml(m.from_username) : "You"}</div>
            <div class="bubble-inner">${escHtml(m.body)}</div>
            <div class="bubble-time">${fmtDate(m.created_at)}</div>
          </div>`;
        if (m.reply_body) {
          html += `
            <div class="bubble from-admin">
              <div class="bubble-name">Admin <span class="admin-chip">ADMIN</span></div>
              <div class="bubble-inner">${escHtml(m.reply_body)}</div>
              <div class="bubble-time">${fmtDate(m.replied_at)}</div>
            </div>`;
        }
        thread.innerHTML = html;
        thread.scrollTop = thread.scrollHeight;

        // Update active state in sidebar
        document.querySelectorAll(".conv-item").forEach(el => el.classList.toggle("active", el.dataset.id === m.id));
      }

      // Reply (admin only)
      document.getElementById("sendReplyBtn")?.addEventListener("click", async () => {
        if (!selectedId) return;
        const text = document.getElementById("replyInput").value.trim();
        if (!text) return;
        const btn = document.getElementById("sendReplyBtn");
        btn.disabled = true; btn.textContent = "Sending...";
        const { error } = await db.from("messages").update({
          reply_body: text, replied: true, replied_at: new Date().toISOString()
        }).eq("id", selectedId);
        btn.disabled = false; btn.textContent = "‚Üë Balas";
        if (error) { showAlert("Failed: " + error.message); return; }
        document.getElementById("replyInput").value = "";
        await loadConversations();
        // Reload the message view
        const { data } = await db.from("messages").select("*").eq("id", selectedId).single();
        if (data) openMsg(data);
      });

      // Compose
      document.getElementById("newMsgBtn")?.addEventListener("click", () => {
        document.getElementById("composeModal").classList.add("show");
      });
      document.getElementById("cancelCompose")?.addEventListener("click", () => {
        document.getElementById("composeModal").classList.remove("show");
      });
      document.getElementById("composeModal")?.addEventListener("click", e => {
        if (e.target === document.getElementById("composeModal"))
          document.getElementById("composeModal").classList.remove("show");
      });
      document.getElementById("sendCompose")?.addEventListener("click", async () => {
        const subject = document.getElementById("composeSubject").value.trim();
        const body = document.getElementById("composeBody").value.trim();
        if (!subject || !body) { showAlert("Please fill subject and message."); return; }
        const btn = document.getElementById("sendCompose");
        btn.disabled = true; btn.textContent = "Sending...";
        const { error } = await db.from("messages").insert({ from_username: username, subject, body });
        btn.disabled = false; btn.textContent = "‚úâÔ∏è Send";
        if (error) { showAlert("Failed: " + error.message); return; }
        document.getElementById("composeModal").classList.remove("show");
        document.getElementById("composeSubject").value = "";
        document.getElementById("composeBody").value = "";
        showAlert("Message sent! ‚úÖ Admin will reply soon.");
        await loadConversations();
      });

      function escHtml(s) {
        return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
      }

      await loadConversations();
    });
  </script>
</body>
</html>
