<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My CV ‚Äî CareerTracker</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" />
  <link rel="stylesheet" href="../assets/css/base.css" />
  <link rel="stylesheet" href="../assets/css/layout.css" />
  <link rel="stylesheet" href="../assets/css/modal.css" />
  <link rel="stylesheet" href="../assets/css/mobile.css" />
  <link rel="stylesheet" href="../assets/css/theme.css" />
  <script>
    (function () {
      const saved = localStorage.getItem("theme");
      if (saved === "dark") document.documentElement.setAttribute("data-theme", "dark");
    })();
  </script>
  <style>
    .cv-page {
      max-width: 860px;
      margin: 0 auto;
      padding: calc(var(--topbar-h) + 2.5rem) 1.5rem 4rem;
    }
    .page-header { margin-bottom: 2rem; display: flex; align-items: flex-end; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
    .page-header h1 { font-size: 1.5rem; font-weight: 800; color: var(--dark); letter-spacing: -0.03em; }
    .page-header p { font-size: 0.85rem; color: var(--muted); margin-top: 0.25rem; }

    /* Upload zone */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius-lg);
      padding: 3rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--card-bg);
      margin-bottom: 1.5rem;
      position: relative;
    }
    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--brand);
      background: rgba(92,102,122,0.04);
    }
    .upload-zone .upload-icon { font-size: 2.5rem; margin-bottom: 0.75rem; display: block; }
    .upload-zone h3 { font-size: 1rem; font-weight: 700; color: var(--dark); margin-bottom: 0.35rem; }
    .upload-zone p { font-size: 0.82rem; color: var(--muted); margin-bottom: 1.25rem; }
    .upload-btn {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.65rem 1.5rem; background: var(--brand); color: white;
      border: none; border-radius: var(--radius-md); font-size: 0.875rem;
      font-weight: 700; font-family: "Poppins", sans-serif; cursor: pointer; transition: all 0.2s;
    }
    .upload-btn:hover { background: var(--brand-dark); transform: translateY(-1px); }
    #cvInput { display: none; }

    /* CV list */
    .cv-list-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 0.875rem;
    }
    .cv-list-header h3 { font-size: 0.85rem; font-weight: 700; color: var(--dark); text-transform: uppercase; letter-spacing: 0.5px; }
    .cv-count-badge {
      background: var(--brand); color: white;
      font-size: 0.7rem; font-weight: 700;
      padding: 0.15rem 0.5rem; border-radius: 2rem;
    }

    /* CV item row */
    .cv-item {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-md); padding: 1rem 1.25rem;
      display: flex; align-items: center; gap: 1rem;
      transition: box-shadow 0.2s, transform 0.2s;
      margin-bottom: 0.625rem; cursor: pointer;
    }
    .cv-item:hover { box-shadow: var(--shadow-md); transform: translateX(3px); border-color: var(--brand); }
    .cv-item.active { border-color: var(--brand); background: rgba(92,102,122,0.04); }
    .cv-item-icon {
      width: 2.75rem; height: 2.75rem; border-radius: var(--radius-sm);
      background: rgba(239,68,68,0.1); color: #ef4444;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.25rem; flex-shrink: 0;
    }
    .cv-item-info { flex: 1; min-width: 0; }
    .cv-item-name { font-size: 0.875rem; font-weight: 600; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cv-item-meta { font-size: 0.72rem; color: var(--muted); margin-top: 0.15rem; }
    .cv-item-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
    .cv-action-btn {
      width: 2rem; height: 2rem; border-radius: 50%;
      border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 0.875rem; transition: all 0.2s; font-family: "Poppins", sans-serif;
    }
    .cv-action-btn.view { background: rgba(59,130,246,0.1); color: var(--blue); }
    .cv-action-btn.view:hover { background: var(--blue); color: white; }
    .cv-action-btn.del { background: rgba(239,68,68,0.1); color: var(--red); }
    .cv-action-btn.del:hover { background: var(--red); color: white; }

    /* Preview panel */
    .preview-panel {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-lg); overflow: hidden;
      box-shadow: var(--shadow-sm); margin-top: 1.5rem;
    }
    .preview-panel-header {
      padding: 0.875rem 1.25rem; border-bottom: 1px solid var(--border);
      background: var(--card-bg); display: flex; align-items: center; justify-content: space-between;
    }
    .preview-panel-header h4 { font-size: 0.82rem; font-weight: 700; color: var(--dark); }
    .preview-close {
      width: 1.75rem; height: 1.75rem; border-radius: 50%; border: none;
      background: var(--border); color: var(--muted); font-size: 0.875rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; font-family: "Poppins", sans-serif;
    }
    .preview-close:hover { background: var(--red); color: white; }
    #cvViewer { width: 100%; height: 640px; display: block; border: none; background: var(--card-bg); }

    /* Empty state */
    .cv-empty {
      text-align: center; padding: 2.5rem 1.5rem;
      border: 2px dashed var(--border); border-radius: var(--radius-md);
      color: var(--muted); font-size: 0.875rem; font-style: italic;
      background: var(--card-bg); margin-bottom: 0.625rem;
    }

    /* Selector (legacy compat) */
    #viewerSection { display: none; }
    #cvSelector { display: none; }

    /* Naming modal */
    #nameModal .modal-content { max-width: 500px; }
    #nameForm label { font-weight: 600; margin-bottom: 0.25rem; display: block; font-size: 0.875rem; }
    #nameForm input[type="text"] {
      padding: 0.6rem 0.875rem; border: 1.5px solid var(--border); border-radius: var(--radius-sm);
      width: 100%; font-family: "Poppins", sans-serif; font-size: 0.875rem; outline: none;
      transition: border-color 0.2s; box-sizing: border-box; margin-bottom: 0.875rem;
      color: var(--text); background: var(--surface);
    }
    #nameForm input[type="text"]:focus { border-color: var(--brand); }

    [data-theme="dark"] .upload-zone { background: var(--card-bg); border-color: var(--border); }
    [data-theme="dark"] .cv-item { background: var(--surface); }
    [data-theme="dark"] .preview-panel { background: var(--surface); }
    [data-theme="dark"] #nameForm input[type="text"] { background: var(--card-bg); color: var(--text); border-color: var(--border); }

    @media (max-width: 600px) {
      .cv-page { padding: calc(var(--topbar-h) + 1.25rem) 1rem 3rem; }
      .upload-zone { padding: 2rem 1.25rem; }
      #cvViewer { height: 480px; }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="left-section">
      <div id="toggleBtn">‚ò∞</div>
      <a href="home.html" class="logo">Career<span>Tracker</span></a>
    </div>
    <div class="right-section">
      <button id="darkModeToggle" title="Toggle dark mode" aria-label="Toggle dark mode">üåô</button>
      <div class="profile" id="profileBtn">
        <span id="topbarDisplayName">-</span>
        <div class="avatar" id="topbarAvatar"></div>
      </div>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="menu">
      <a href="home.html"       class="menu-item" data-title="Home">üè† <span>Home</span></a>
      <a href="how-to-use.html" class="menu-item" data-title="How to Use">üìñ <span>How to Use</span></a>
      <a href="about.html"      class="menu-item" data-title="About">‚ÑπÔ∏è <span>About</span></a>
    </div>
  </aside>
  <div id="sidebarOverlay"></div>

  <div class="profile-dropdown" id="dropdown">
    <div>üë§ Profile</div>
    <div id="cvLink">üìÑ My CV</div>
    <hr />
    <div class="logout">üö™ Sign Out</div>
  </div>

  <main class="main" id="main">
    <div class="cv-page">
      <div class="page-header">
        <div>
          <h1>My CV</h1>
          <p>Upload and manage your CV files. Preview PDFs directly in the app.</p>
        </div>
      </div>

      <!-- Upload zone -->
      <label class="upload-zone" for="cvInput" id="cvChooseLabel">
        <span class="upload-icon">üìÇ</span>
        <h3>Drop your CV here or click to upload</h3>
        <p>Supports PDF files. You can upload multiple versions.</p>
        <span class="upload-btn">üìÅ Choose Files</span>
      </label>
      <input type="file" id="cvInput" accept="application/pdf" multiple />

      <!-- Upload confirm button (hidden until file chosen) -->
      <div id="uploadConfirmRow" style="margin-bottom:1.25rem;display:none">
        <button id="cvUploadBtn" class="upload-btn">‚¨ÜÔ∏è Upload Selected Files</button>
      </div>

      <!-- Legacy selector (hidden, used by cvPage.js) -->
      <div id="viewerSection">
        <select id="cvSelector"></select>
      </div>

      <!-- CV list -->
      <div class="cv-list-header">
        <h3>üìÑ Your CVs</h3>
        <span class="cv-count-badge" id="cvCountBadge">0</span>
      </div>
      <div id="cvContainer">
        <div class="cv-empty">No CV uploaded yet. Upload your first CV above.</div>
      </div>

      <!-- Preview panel -->
      <div class="preview-panel" id="previewPanel" style="display:none">
        <div class="preview-panel-header">
          <h4 id="previewTitle">Preview</h4>
          <button class="preview-close" id="previewClose">‚úï</button>
        </div>
        <iframe id="cvViewer" title="CV Preview"></iframe>
      </div>

      <!-- Naming modal -->
      <div id="nameModal" class="modal" style="display:none">
        <div class="modal-content">
          <span class="close-name">&times;</span>
          <h2>Name Your CV Files</h2>
          <div id="nameForm"></div>
          <button id="nameConfirm" class="btn save">Confirm</button>
        </div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="../assets/js/supabaseClient.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/ui.js"></script>
  <script src="../assets/js/dataService.js"></script>
  <script src="../assets/js/api.js"></script>
  <script src="../assets/js/main.js"></script>
  <script src="../assets/js/cvPage.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Dark mode toggle
      const btn = document.getElementById("darkModeToggle");
      const html = document.documentElement;
      function updateIcon() {
        const isDark = html.getAttribute("data-theme") === "dark";
        btn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
      }
      updateIcon();
      btn.addEventListener("click", function () {
        const isDark = html.getAttribute("data-theme") === "dark";
        if (isDark) { html.removeAttribute("data-theme"); localStorage.setItem("theme", "light"); }
        else        { html.setAttribute("data-theme", "dark"); localStorage.setItem("theme", "dark"); }
        updateIcon();
      });

      // Show upload confirm button when file is chosen
      const cvInput = document.getElementById("cvInput");
      const uploadConfirmRow = document.getElementById("uploadConfirmRow");
      if (cvInput && uploadConfirmRow) {
        cvInput.addEventListener("change", function () {
          uploadConfirmRow.style.display = cvInput.files.length > 0 ? "block" : "none";
        });
      }

      // Preview close button
      const previewClose = document.getElementById("previewClose");
      const previewPanel = document.getElementById("previewPanel");
      if (previewClose && previewPanel) {
        previewClose.addEventListener("click", function () {
          previewPanel.style.display = "none";
          const viewer = document.getElementById("cvViewer");
          if (viewer) viewer.src = "";
        });
      }

      // Patch cvPage.js viewer to use new preview panel
      const origSelector = document.getElementById("cvSelector");
      if (origSelector) {
        origSelector.addEventListener("change", function () {
          const val = origSelector.value;
          if (!val) return;
          const viewer = document.getElementById("cvViewer");
          const previewPanel = document.getElementById("previewPanel");
          const previewTitle = document.getElementById("previewTitle");
          if (viewer && previewPanel) {
            viewer.src = val;
            previewPanel.style.display = "block";
            if (previewTitle) {
              const opt = origSelector.options[origSelector.selectedIndex];
              previewTitle.textContent = "Preview ‚Äî " + (opt ? opt.textContent : "CV");
            }
            previewPanel.scrollIntoView({ behavior: "smooth", block: "nearest" });
          }
        });
      }

      // Update cv count badge whenever cvContainer changes
      const cvContainer = document.getElementById("cvContainer");
      const cvCountBadge = document.getElementById("cvCountBadge");
      if (cvContainer && cvCountBadge) {
        const mo = new MutationObserver(() => {
          const items = cvContainer.querySelectorAll("li, .cv-item");
          cvCountBadge.textContent = items.length;
        });
        mo.observe(cvContainer, { childList: true, subtree: true });
      }
    });
  </script>
</body>
</html>