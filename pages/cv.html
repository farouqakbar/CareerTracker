<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My CV ‚Äî CareerTracker</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" />
  <link rel="stylesheet" href="../assets/css/base.css" />
  <link rel="stylesheet" href="../assets/css/layout.css" />
  <link rel="stylesheet" href="../assets/css/modal.css" />
  <link rel="stylesheet" href="../assets/css/mobile.css" />
  <link rel="stylesheet" href="../assets/css/theme.css" />
  <script>
    (function () {
      const saved = localStorage.getItem("theme");
      if (saved === "dark") document.documentElement.setAttribute("data-theme", "dark");
    })();
  </script>
  <style>
    /* ‚îÄ‚îÄ CV page wrapper ‚îÄ‚îÄ */
    .cv-page {
      max-width: 860px;
      margin: 0 auto;
      padding: calc(var(--topbar-h) + 2rem) 1.5rem 4rem;
      box-sizing: border-box;
    }

    /* ‚îÄ‚îÄ Page header ‚îÄ‚îÄ */
    .page-header {
      margin-bottom: 1.75rem;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .page-header h1 {
      font-size: 1.4rem; font-weight: 800;
      color: var(--dark); letter-spacing: -0.03em;
    }
    .page-header p { font-size: 0.82rem; color: var(--muted); margin-top: 0.2rem; }

    /* ‚îÄ‚îÄ Upload zone ‚îÄ‚îÄ */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius-lg);
      padding: 2.5rem 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--card-bg);
      margin-bottom: 1.25rem;
      display: block;
      box-sizing: border-box;
      width: 100%;
    }
    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--brand);
      background: rgba(92,102,122,0.04);
    }
    .upload-zone .upload-icon {
      font-size: 2.2rem; margin-bottom: 0.625rem; display: block;
    }
    .upload-zone h3 {
      font-size: 0.95rem; font-weight: 700;
      color: var(--dark); margin-bottom: 0.3rem;
    }
    .upload-zone p {
      font-size: 0.8rem; color: var(--muted); margin-bottom: 1rem;
    }
    .upload-btn {
      display: inline-flex; align-items: center; gap: 0.4rem;
      padding: 0.6rem 1.25rem; background: var(--brand); color: white;
      border: none; border-radius: var(--radius-md); font-size: 0.85rem;
      font-weight: 700; font-family: "Poppins", sans-serif;
      cursor: pointer; transition: all 0.2s;
      white-space: nowrap;
    }
    .upload-btn:hover { background: var(--brand-dark); transform: translateY(-1px); }
    #cvInput { display: none; }

    /* ‚îÄ‚îÄ Upload confirm row ‚îÄ‚îÄ */
    #uploadConfirmRow { margin-bottom: 1rem; }
    #uploadConfirmRow .upload-btn {
      width: auto;
      background: var(--green);
    }
    #uploadConfirmRow .upload-btn:hover { background: #16a34a; }

    /* ‚îÄ‚îÄ CV list header ‚îÄ‚îÄ */
    .cv-list-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 0.75rem;
    }
    .cv-list-header h3 {
      font-size: 0.82rem; font-weight: 700;
      color: var(--dark); text-transform: uppercase; letter-spacing: 0.5px;
    }
    .cv-count-badge {
      background: var(--brand); color: white;
      font-size: 0.68rem; font-weight: 700;
      padding: 0.12rem 0.45rem; border-radius: 2rem;
    }

    /* ‚îÄ‚îÄ CV item row ‚îÄ‚îÄ */
    .cv-item {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 0.875rem 1rem;
      display: flex; align-items: center; gap: 0.75rem;
      transition: box-shadow 0.2s, transform 0.2s, border-color 0.2s;
      margin-bottom: 0.5rem; cursor: pointer;
      min-width: 0;
    }
    .cv-item:hover {
      box-shadow: var(--shadow-md); transform: translateX(3px);
      border-color: var(--brand);
    }
    .cv-item.active { border-color: var(--brand); background: rgba(92,102,122,0.04); }

    .cv-item-icon {
      width: 2.5rem; height: 2.5rem; border-radius: var(--radius-sm);
      background: rgba(239,68,68,0.1); color: #ef4444;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem; flex-shrink: 0;
    }
    .cv-item-info { flex: 1; min-width: 0; overflow: hidden; }
    .cv-item-name {
      font-size: 0.875rem; font-weight: 600; color: var(--dark);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .cv-item-meta { font-size: 0.7rem; color: var(--muted); margin-top: 0.1rem; }
    .cv-item-actions { display: flex; gap: 0.4rem; flex-shrink: 0; }

    .cv-action-btn {
      width: 1.875rem; height: 1.875rem; border-radius: 50%;
      border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.82rem; transition: all 0.2s;
      font-family: "Poppins", sans-serif;
    }
    .cv-action-btn.view { background: rgba(59,130,246,0.1); color: var(--blue); }
    .cv-action-btn.view:hover { background: var(--blue); color: white; }
    .cv-action-btn.del  { background: rgba(239,68,68,0.1); color: var(--red); }
    .cv-action-btn.del:hover  { background: var(--red); color: white; }

    /* ‚îÄ‚îÄ Preview panel ‚îÄ‚îÄ */
    .preview-panel {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-lg); overflow: hidden;
      box-shadow: var(--shadow-sm); margin-top: 1.25rem;
    }
    .preview-panel-header {
      padding: 0.75rem 1rem; border-bottom: 1px solid var(--border);
      background: var(--card-bg);
      display: flex; align-items: center; justify-content: space-between;
      gap: 0.5rem;
    }
    .preview-panel-header h4 {
      font-size: 0.8rem; font-weight: 700; color: var(--dark);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .preview-close {
      width: 1.625rem; height: 1.625rem; border-radius: 50%; border: none;
      background: var(--border); color: var(--muted); font-size: 0.8rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; font-family: "Poppins", sans-serif; flex-shrink: 0;
    }
    .preview-close:hover { background: var(--red); color: white; }

    #cvViewer {
      width: 100%;
      height: clamp(320px, 70vh, 800px);
      display: block; border: none;
      background: var(--card-bg);
    }

    /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
    .cv-empty {
      text-align: center; padding: 2rem 1.25rem;
      border: 2px dashed var(--border); border-radius: var(--radius-md);
      color: var(--muted); font-size: 0.85rem; font-style: italic;
      background: var(--card-bg); margin-bottom: 0.5rem;
    }

    /* ‚îÄ‚îÄ Legacy compat ‚îÄ‚îÄ */
    #viewerSection { display: none; }
    #cvSelector    { display: none; }

    /* ‚îÄ‚îÄ Naming modal ‚îÄ‚îÄ */
    #nameModal .modal-content {
      max-width: 520px; width: calc(100% - 2rem);
    }
    #nameForm label {
      font-weight: 600; margin-bottom: 0.25rem;
      display: block; font-size: 0.875rem;
    }
    #nameForm input[type="text"] {
      padding: 0.6rem 0.875rem;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      width: 100%; font-family: "Poppins", sans-serif;
      font-size: 0.875rem; outline: none;
      transition: border-color 0.2s;
      box-sizing: border-box; margin-bottom: 0.75rem;
      color: var(--text); background: var(--surface);
    }
    #nameForm input[type="text"]:focus { border-color: var(--brand); }

    /* ‚îÄ‚îÄ Dark mode ‚îÄ‚îÄ */
    [data-theme="dark"] .upload-zone { background: var(--card-bg); border-color: var(--border); }
    [data-theme="dark"] .upload-zone h3 { color: var(--text); }
    [data-theme="dark"] .cv-item { background: var(--surface); }
    [data-theme="dark"] .cv-item-name { color: var(--text); }
    [data-theme="dark"] .preview-panel { background: var(--surface); }
    [data-theme="dark"] .preview-panel-header { background: var(--card-bg); }
    [data-theme="dark"] .preview-panel-header h4 { color: var(--text); }
    [data-theme="dark"] #cvViewer { background: var(--card-bg); }
    [data-theme="dark"] #nameForm input[type="text"] {
      background: var(--card-bg); color: var(--text); border-color: var(--border);
    }
    [data-theme="dark"] .page-header h1 { color: var(--text); }

    /* ‚îÄ‚îÄ Responsive: tablet ‚îÄ‚îÄ */
    @media (max-width: 768px) {
      .cv-page { padding: calc(var(--topbar-h) + 1.5rem) 1rem 3rem; }
      .upload-zone { padding: 2rem 1rem; }
      #cvViewer { height: clamp(280px, 60vh, 600px); }
    }

    /* ‚îÄ‚îÄ Responsive: mobile ‚îÄ‚îÄ */
    @media (max-width: 480px) {
      .cv-page { padding: calc(var(--topbar-h) + 1rem) 0.75rem 2.5rem; }
      .upload-zone { padding: 1.5rem 0.75rem; }
      .upload-zone h3 { font-size: 0.875rem; }
      .upload-zone p { font-size: 0.75rem; }
      .cv-item { padding: 0.75rem 0.75rem; }
      .cv-item-name { font-size: 0.8rem; }
      .cv-item-icon { width: 2.25rem; height: 2.25rem; font-size: 1rem; }
      #cvViewer { height: clamp(240px, 55vh, 500px); }
      #nameModal .modal-content { padding: 1.25rem 1rem; }
      .page-header h1 { font-size: 1.2rem; }
    }

    /* ‚îÄ‚îÄ Responsive: small phone ‚îÄ‚îÄ */
    @media (max-width: 360px) {
      .cv-page { padding: calc(var(--topbar-h) + 0.75rem) 0.5rem 2rem; }
      .upload-zone { padding: 1.25rem 0.5rem; }
      .cv-item { gap: 0.5rem; padding: 0.625rem 0.625rem; }
      .cv-action-btn { width: 1.625rem; height: 1.625rem; font-size: 0.75rem; }
      #cvViewer { height: clamp(220px, 50vh, 400px); }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="left-section">
      <div id="toggleBtn">‚ò∞</div>
      <a href="home.html" class="logo">Career<span>Tracker</span></a>
    </div>
    <div class="right-section">
      <button id="darkModeToggle" title="Toggle dark mode" aria-label="Toggle dark mode">üåô</button>
      <div class="profile" id="profileBtn">
        <span id="topbarDisplayName">-</span>
        <div class="avatar" id="topbarAvatar"></div>
      </div>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="menu">
      <a href="home.html"       class="menu-item" data-title="Home">üè† <span>Home</span></a>
      <a href="how-to-use.html" class="menu-item" data-title="How to Use">üìñ <span>How to Use</span></a>
      <a href="about.html"      class="menu-item" data-title="About">‚ÑπÔ∏è <span>About</span></a>
    </div>
  </aside>
  <div id="sidebarOverlay"></div>

  <div class="profile-dropdown" id="dropdown">
    <div>üë§ Profile</div>
    <div id="cvLink">üìÑ My CV</div>
    <hr />
    <div class="logout">üö™ Sign Out</div>
  </div>

  <main class="main" id="main">
    <div class="cv-page">
      <div class="page-header">
        <div>
          <h1>My CV</h1>
          <p>Upload and manage your CV files. Preview PDFs directly in the app.</p>
        </div>
      </div>

      <!-- Upload zone -->
      <label class="upload-zone" for="cvInput" id="cvChooseLabel">
        <span class="upload-icon">üìÇ</span>
        <h3>Drop your CV here or click to upload</h3>
        <p>Supports PDF files. You can upload multiple versions.</p>
        <span class="upload-btn">üìÅ Choose Files</span>
      </label>
      <input type="file" id="cvInput" accept="application/pdf" multiple />

      <!-- Upload confirm button (hidden until file chosen) -->
      <div id="uploadConfirmRow" style="margin-bottom:1.25rem;display:none">
        <button id="cvUploadBtn" class="upload-btn">‚¨ÜÔ∏è Upload Selected Files</button>
      </div>

      <!-- Legacy selector (hidden, used by cvPage.js) -->
      <div id="viewerSection">
        <select id="cvSelector"></select>
      </div>

      <!-- CV list -->
      <div class="cv-list-header">
        <h3>üìÑ Your CVs</h3>
        <span class="cv-count-badge" id="cvCountBadge">0</span>
      </div>
      <div id="cvContainer">
        <div class="cv-empty">No CV uploaded yet. Upload your first CV above.</div>
      </div>

      <!-- Preview panel -->
      <div class="preview-panel" id="previewPanel" style="display:none">
        <div class="preview-panel-header">
          <h4 id="previewTitle">Preview</h4>
          <button class="preview-close" id="previewClose">‚úï</button>
        </div>
        <iframe id="cvViewer" title="CV Preview"></iframe>
      </div>

      <!-- Naming modal -->
      <div id="nameModal" class="modal" style="display:none">
        <div class="modal-content">
          <span class="close-name">&times;</span>
          <h2>Name Your CV Files</h2>
          <div id="nameForm"></div>
          <button id="nameConfirm" class="btn save">Confirm</button>
        </div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="../assets/js/supabaseClient.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/ui.js"></script>
  <script src="../assets/js/dataService.js"></script>
  <script src="../assets/js/api.js"></script>
  <script src="../assets/js/main.js"></script>
  <script src="../assets/js/cvPage.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Dark mode toggle
      const btn = document.getElementById("darkModeToggle");
      const html = document.documentElement;
      function updateIcon() {
        const isDark = html.getAttribute("data-theme") === "dark";
        btn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
      }
      updateIcon();
      btn.addEventListener("click", function () {
        const isDark = html.getAttribute("data-theme") === "dark";
        if (isDark) { html.removeAttribute("data-theme"); localStorage.setItem("theme", "light"); }
        else        { html.setAttribute("data-theme", "dark"); localStorage.setItem("theme", "dark"); }
        updateIcon();
      });

      // Show upload confirm button when file is chosen
      const cvInput = document.getElementById("cvInput");
      const uploadConfirmRow = document.getElementById("uploadConfirmRow");
      if (cvInput && uploadConfirmRow) {
        cvInput.addEventListener("change", function () {
          uploadConfirmRow.style.display = cvInput.files.length > 0 ? "block" : "none";
        });
      }

      // Preview close button
      const previewClose = document.getElementById("previewClose");
      const previewPanel = document.getElementById("previewPanel");
      if (previewClose && previewPanel) {
        previewClose.addEventListener("click", function () {
          previewPanel.style.display = "none";
          const viewer = document.getElementById("cvViewer");
          if (viewer) viewer.src = "";
        });
      }

      // Patch cvPage.js viewer to use new preview panel
      const origSelector = document.getElementById("cvSelector");
      if (origSelector) {
        origSelector.addEventListener("change", function () {
          const val = origSelector.value;
          if (!val) return;
          const viewer = document.getElementById("cvViewer");
          const previewPanel = document.getElementById("previewPanel");
          const previewTitle = document.getElementById("previewTitle");
          if (viewer && previewPanel) {
            viewer.src = val;
            previewPanel.style.display = "block";
            if (previewTitle) {
              const opt = origSelector.options[origSelector.selectedIndex];
              previewTitle.textContent = "Preview ‚Äî " + (opt ? opt.textContent : "CV");
            }
            previewPanel.scrollIntoView({ behavior: "smooth", block: "nearest" });
          }
        });
      }

      // Update cv count badge whenever cvContainer changes
      const cvContainer = document.getElementById("cvContainer");
      const cvCountBadge = document.getElementById("cvCountBadge");
      if (cvContainer && cvCountBadge) {
        const mo = new MutationObserver(() => {
          const items = cvContainer.querySelectorAll("li, .cv-item");
          cvCountBadge.textContent = items.length;
        });
        mo.observe(cvContainer, { childList: true, subtree: true });
      }
    });
  </script>
</body>
</html>