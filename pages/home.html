<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CareerTracker - Home</title>

    <script>
      (function () {
        if (localStorage.getItem("theme") === "dark")
          document.documentElement.setAttribute("data-theme", "dark");
      })();
    </script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" />
    <link rel="stylesheet" href="../assets/css/base.css" />
    <link rel="stylesheet" href="../assets/css/layout.css" />
    <link rel="stylesheet" href="../assets/css/components.css" />
    <link rel="stylesheet" href="../assets/css/modal.css" />
    <link rel="stylesheet" href="../assets/css/mobile.css" />
    <link rel="stylesheet" href="../assets/css/theme.css" />

    <style>
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         3D CARD CAROUSEL â€” Responsive Full-Width HD
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
      .card-carousel-section {
        margin-bottom: 0;
        user-select: none;
        padding-bottom: 0.25rem;
      }

      /* Stage: full width, responsive height via clamp */
      .carousel-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        width: 100%;
        height: clamp(200px, 28vw, 280px);
        perspective: 1400px;
        perspective-origin: 50% 50%;
        overflow: visible;
      }

      .card-stage {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* â”€â”€ Base card â€” responsive width via clamp â”€â”€ */
      .carousel-card {
        position: absolute;
        /* responsive card size: min 180px, scale with viewport, max 300px */
        width: clamp(180px, 26vw, 300px);
        min-height: clamp(150px, 22vw, 240px);
        border-radius: 24px;
        padding: clamp(1.25rem, 2.5vw, 2.25rem) clamp(1rem, 2vw, 2rem);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: clamp(0.3rem, 0.6vw, 0.6rem);
        text-align: center;
        cursor: pointer;
        transition:
          transform  0.6s cubic-bezier(0.34, 1.15, 0.64, 1),
          opacity    0.45s ease,
          filter     0.45s ease,
          box-shadow 0.5s ease;
        will-change: transform, opacity, filter;
        border: 1px solid transparent;
        overflow: hidden; /* clips ::before accent bar to border-radius */
        /* ensure crisp rendering */
        -webkit-font-smoothing: antialiased;
        backface-visibility: hidden;
      }

      /* â”€â”€ CENTER card â”€â”€ */
      .carousel-card.cc-center {
        background: linear-gradient(150deg, #1c2040 0%, #2a3060 50%, #1e2445 100%);
        border-color: rgba(255,255,255,0.10);
        box-shadow:
          0 40px 80px rgba(0,0,0,0.55),
          0 16px 40px rgba(0,0,0,0.3),
          0 0 0 1px rgba(255,255,255,0.06),
          inset 0 1px 0 rgba(255,255,255,0.12);
        transform: translateX(0) scale(1) rotateY(0deg) translateZ(0);
        opacity: 1;
        filter: none;
        z-index: 10;
        cursor: default;
      }

      /* â”€â”€ Top accent line â€” clean, flush with border-radius â”€â”€ */
      .carousel-card.cc-center::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        /* clip to match card's top border-radius exactly */
        border-radius: 24px 24px 0 0;
        background: linear-gradient(
          90deg,
          var(--brand, #5c667a) 0%,
          #7c8aff 40%,
          var(--accent, #f4b960) 100%
        );
        /* no overflow bleed */
        overflow: hidden;
      }

      /* â”€â”€ LEFT silhouette â”€â”€ */
      .carousel-card.cc-left {
        background: rgba(20,23,40,0.6);
        border-color: rgba(255,255,255,0.04);
        box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        /* offset = ~75% of card width from center */
        transform: translateX(clamp(-260px, -30vw, -190px)) scale(0.76) rotateY(30deg) translateZ(-40px);
        opacity: 0.48;
        filter: blur(1.5px) brightness(0.6);
        z-index: 5;
      }
      .carousel-card.cc-left:hover {
        opacity: 0.68;
        filter: blur(0.5px) brightness(0.78);
      }

      /* â”€â”€ RIGHT silhouette â”€â”€ */
      .carousel-card.cc-right {
        background: rgba(20,23,40,0.6);
        border-color: rgba(255,255,255,0.04);
        box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        transform: translateX(clamp(190px, 30vw, 260px)) scale(0.76) rotateY(-30deg) translateZ(-40px);
        opacity: 0.48;
        filter: blur(1.5px) brightness(0.6);
        z-index: 5;
      }
      .carousel-card.cc-right:hover {
        opacity: 0.68;
        filter: blur(0.5px) brightness(0.78);
      }

      /* Dark mode */
      [data-theme="dark"] .carousel-card.cc-center {
        background: linear-gradient(150deg, #242840 0%, #2e3560 50%, #1e2445 100%);
        border-color: rgba(255,255,255,0.09);
      }
      [data-theme="dark"] .carousel-card.cc-left,
      [data-theme="dark"] .carousel-card.cc-right {
        background: rgba(30, 35, 60, 0.55);
      }

      /* â”€â”€ Card content â€” responsive sizes â”€â”€ */
      .cc-icon {
        font-size: clamp(1.6rem, 3vw, 2.4rem);
        line-height: 1;
        filter: drop-shadow(0 2px 8px rgba(0,0,0,0.4));
      }
      .cc-number {
        font-size: clamp(2.2rem, 5vw, 3.8rem);
        font-weight: 800;
        color: #fff;
        line-height: 1;
        letter-spacing: -0.04em;
        text-shadow: 0 2px 12px rgba(0,0,0,0.3);
      }
      .carousel-card[data-type="weekly"] .cc-number {
        color: var(--accent, #f4b960);
        text-shadow: 0 2px 16px rgba(244,185,96,0.35);
      }
      .cc-label {
        font-size: clamp(0.58rem, 0.9vw, 0.76rem);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1.4px;
        color: rgba(255,255,255,0.42);
        margin-top: 0.1rem;
      }
      .cc-sub {
        font-size: clamp(0.58rem, 0.8vw, 0.7rem);
        color: rgba(255,255,255,0.22);
      }

      /* Dim silhouette card text heavily */
      .carousel-card.cc-left .cc-icon,
      .carousel-card.cc-left .cc-number,
      .carousel-card.cc-left .cc-sub,
      .carousel-card.cc-right .cc-icon,
      .carousel-card.cc-right .cc-number,
      .carousel-card.cc-right .cc-sub { opacity: 0.18; }
      .carousel-card.cc-left .cc-label,
      .carousel-card.cc-right .cc-label { opacity: 0.35; font-size: 0.58rem; }

      /* â”€â”€ Arrow nav buttons â”€â”€ */
      .carousel-arrow {
        position: absolute; z-index: 20;
        width: clamp(36px, 4vw, 48px);
        height: clamp(36px, 4vw, 48px);
        border-radius: 50%;
        border: 1.5px solid rgba(255,255,255,0.14);
        background: rgba(22,26,48,0.82);
        color: rgba(255,255,255,0.88);
        font-size: clamp(1.2rem, 2vw, 1.7rem);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        transition: all 0.22s ease;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 0; line-height: 1;
        box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      }
      .carousel-arrow:hover {
        background: var(--brand, #5c667a);
        border-color: var(--brand, #5c667a);
        color: #fff;
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(92,102,122,0.4);
      }
      .carousel-prev { left: 0; }
      .carousel-next { right: 0; }

      /* â”€â”€ Dot indicators â”€â”€ */
      .carousel-dots {
        display: flex; justify-content: center;
        gap: 0.5rem; margin-top: 1rem;
      }
      .c-dot {
        width: 7px; height: 7px; border-radius: 50%;
        background: rgba(92,102,122,0.28);
        transition: all 0.3s ease; cursor: pointer;
      }
      .c-dot.active {
        width: 24px; border-radius: 4px;
        background: var(--brand, #5c667a);
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         CONTENT PANELS
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
      .content-panel { display: none; animation: panelIn 0.38s ease; }
      .content-panel.active { display: block; }

      @keyframes panelIn {
        from { opacity: 0; transform: translateY(12px); }
        to   { opacity: 1; transform: translateY(0); }
      }

      .section-divider { height: 1px; background: var(--border); margin: 1.25rem 0 1.1rem; }

      .panel-header {
        display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;
      }
      .panel-accent-bar {
        width: 3px; height: 1rem;
        background: var(--accent, #f4b960);
        border-radius: 2px; flex-shrink: 0;
      }
      .panel-header h3 {
        font-size: 1rem; font-weight: 700; color: var(--text); letter-spacing: -0.01em;
      }

      .panel-toolbar {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 0.85rem; gap: 0.75rem; flex-wrap: wrap;
      }
      .panel-search { flex: 1; min-width: 140px; }
      .panel-search input {
        width: 100%;
        padding: 0.5rem 1rem 0.5rem 2.1rem;
        border: 1.5px solid var(--border);
        border-radius: 2rem; font-size: 0.85rem; color: var(--text);
        background: var(--surface)
          url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='13' height='13' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E")
          0.7rem center no-repeat;
        outline: none; transition: border-color 0.2s;
        font-family: "Poppins", sans-serif;
      }
      .panel-search input:focus { border-color: var(--brand); }

      /* â”€â”€ Priority modal styles â”€â”€ */
      #priorityModal .modal-content.small { max-width: 380px; }
      #priorityOptions { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem; }
      .priority-option-btn {
        padding: 0.625rem 0.875rem;
        border: 1.5px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--surface);
        color: var(--text);
        font-family: "Poppins", sans-serif;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        text-align: left;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .priority-option-btn:hover { border-color: var(--brand); background: var(--card-bg); }
      .priority-option-btn.current { border-color: var(--accent); background: rgba(244,185,96,0.08); font-weight: 700; }
      .priority-option-btn .pri-num {
        width: 1.5rem; height: 1.5rem; border-radius: 4px;
        background: var(--brand); color: white;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.75rem; font-weight: 700; flex-shrink: 0;
      }
      .priority-option-btn.current .pri-num { background: var(--accent); color: var(--dark); }
    </style>
  </head>
  <body>

    <!-- TOPBAR -->
    <header class="topbar">
      <div class="left-section">
        <div id="toggleBtn">â˜°</div>
        <a href="home.html" class="logo" style="text-decoration:none">Career<span>Tracker</span></a>
      </div>
      <div class="right-section">
        <button id="darkModeToggle" title="Switch to dark mode" aria-label="Toggle dark mode">ğŸŒ™</button>
        <div class="profile" id="profileBtn">
          <span id="topbarDisplayName">-</span>
          <div class="avatar" id="topbarAvatar"></div>
        </div>
      </div>
    </header>

    <!-- SIDEBAR â€” Updated: Home, How to use, About us -->
    <aside class="sidebar" id="sidebar">
      <div class="menu">
        <a href="home.html"   class="menu-item active" data-title="Home">ğŸ  <span>Home</span></a>
        <a href="how-to-use.html" class="menu-item" data-title="How to Use">ğŸ“– <span>How to Use</span></a>
        <a href="about.html" class="menu-item" data-title="About">â„¹ï¸ <span>About</span></a>
      </div>
    </aside>
    <div id="sidebarOverlay"></div>

    <!-- PROFILE DROPDOWN -->
    <div class="profile-dropdown" id="dropdown">
      <div>ğŸ‘¤ Profile</div>
      <div id="cvLink">ğŸ“„ My CV</div>
      <hr />
      <div class="logout">ğŸšª Sign Out</div>
    </div>

    <!-- MAIN -->
    <main class="main" id="main">

      <!-- 3D Card Carousel -->
      <section class="card-carousel-section">
        <div class="carousel-wrapper">
          <button class="carousel-arrow carousel-prev" id="carouselPrev">&#8249;</button>

          <div class="card-stage" id="cardStage">
            <!-- Card 0: Job Vacancy -->
            <div class="carousel-card" data-index="0" data-type="jobs">
              <div class="cc-icon">ğŸ“</div>
              <div class="cc-number" id="jobCount">-</div>
              <div class="cc-label">Job Vacancy</div>
              <div class="cc-sub">Lowongan tersimpan</div>
            </div>
            <!-- Card 1: Weekly Schedule (default center) -->
            <div class="carousel-card" data-index="1" data-type="weekly">
              <div class="cc-icon">ğŸ“…</div>
              <div class="cc-number" id="weeklyCount">0</div>
              <div class="cc-label">Weekly Schedule</div>
              <div class="cc-sub">Event 7 hari ke depan</div>
            </div>
            <!-- Card 2: Active Application -->
            <div class="carousel-card" data-index="2" data-type="applied">
              <div class="cc-icon">ğŸ“„</div>
              <div class="cc-number" id="activeCount">0</div>
              <div class="cc-label">Active Application</div>
              <div class="cc-sub">Lamaran sedang berjalan</div>
            </div>
          </div>

          <button class="carousel-arrow carousel-next" id="carouselNext">&#8250;</button>
        </div>

        <div class="carousel-dots" id="carouselDots">
          <span class="c-dot" data-i="0"></span>
          <span class="c-dot" data-i="1"></span>
          <span class="c-dot" data-i="2"></span>
        </div>
      </section>

      <div class="section-divider"></div>

      <!-- PANEL: Weekly Schedule -->
      <section class="content-panel active" id="panel-weekly">
        <div class="panel-header">
          <div class="panel-accent-bar"></div>
          <h3>Weekly Schedule</h3>
        </div>
        <div id="upcomingContainer"></div>
      </section>

      <!-- PANEL: Active Application -->
      <section class="content-panel" id="panel-applied">
        <div class="panel-toolbar">
          <div class="panel-header" style="margin-bottom:0">
            <div class="panel-accent-bar"></div>
            <h3>Active Application</h3>
          </div>
          <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
            <div class="panel-search">
              <input type="text" id="appliedSearchInput" placeholder="Search company..." list="appliedSuggestions"/>
              <datalist id="appliedSuggestions"></datalist>
            </div>
            <button class="btn add" id="appliedAddBtn">+ Add</button>
          </div>
        </div>
        <div class="table-container">
          <table class="applied-table">
            <thead>
              <tr>
                <th>Priority</th><th>Date</th><th>Company</th>
                <th>Program</th><th>Position</th><th>Status</th>
                <th>Stage</th><th>Detail</th>
              </tr>
            </thead>
            <tbody id="applicationsBody"></tbody>
          </table>
        </div>
      </section>

      <!-- PANEL: Job Vacancy -->
      <section class="content-panel" id="panel-jobs">
        <div class="panel-toolbar">
          <div class="panel-header" style="margin-bottom:0">
            <div class="panel-accent-bar"></div>
            <h3>Job Vacancy</h3>
          </div>
          <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
            <div class="panel-search">
              <input type="text" id="jobsSearchInput" placeholder="Search company..." list="jobsSuggestions"/>
              <datalist id="jobsSuggestions"></datalist>
            </div>
            <button class="btn add" id="jobsAddBtn">+ Add</button>
          </div>
        </div>
        <div class="table-container">
          <table class="applied-table">
            <thead>
              <tr>
                <th>Priority</th><th>Company</th><th>Program</th>
                <th>Position</th><th>Deadline</th><th>Status</th>
                <th>Link</th><th>Delete</th>
              </tr>
            </thead>
            <tbody id="vacanciesBody"></tbody>
          </table>
        </div>
      </section>

    </main>

    <!-- â•â• MODALS â•â• -->

    <!-- Add Application -->
    <div id="addAppModal" class="modal" style="display:none">
      <div class="modal-content">
        <span class="close" id="closeAddApp">&times;</span>
        <h2>Add Application</h2>
        <div class="form-group"><label>Company Name</label><input type="text" id="appModalCompany"/></div>
        <div class="form-group"><label>Program Name</label><input type="text" id="appModalProgram"/></div>
        <div class="form-group"><label>Position</label><input type="text" id="appModalJobTitle"/></div>
        <button id="appModalSave" class="btn save">Save</button>
      </div>
    </div>

    <!-- Add Vacancy -->
    <div id="addJobModal" class="modal" style="display:none">
      <div class="modal-content">
        <span class="close" id="closeAddJob">&times;</span>
        <h2>Add Vacancy</h2>
        <div class="form-group"><label>Company Name</label><input type="text" id="jobModalCompany"/></div>
        <div class="form-group"><label>Program Name</label><input type="text" id="jobModalProgram"/></div>
        <div class="form-group"><label>Position</label><input type="text" id="jobModalJobTitle"/></div>
        <div class="form-group"><label>Application Deadline</label><input type="date" id="jobModalDeadline"/></div>
        <div class="form-group"><label>Registration Link</label><input type="url" id="jobModalLink"/></div>
        <button id="jobModalSave" class="btn save">Save</button>
      </div>
    </div>

    <!-- Delete Vacancy -->
    <div id="deleteJobModal" class="modal" style="display:none">
      <div class="modal-content">
        <span class="close-delete" id="closeDeleteJob">&times;</span>
        <h2>Delete vacancy?</h2>
        <div class="form-group"><label id="delJobCompany">ğŸ¢ Company:</label></div>
        <div class="form-group"><label id="delJobProgram">ğŸ·ï¸ Program:</label></div>
        <div class="form-group"><label id="delJobStage">ğŸ“ Position:</label></div>
        <button id="deleteJobConfirm" class="btn danger">Delete</button>
      </div>
    </div>

    <!-- Priority Modal -->
    <div id="priorityModal" class="modal" style="display:none">
      <div class="modal-content small">
        <span class="close-priority">&times;</span>
        <h2>Change Priority</h2>
        <div id="priorityOptions"></div>
      </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="customConfirmModal" class="modal" style="display:none">
      <div class="modal-content">
        <h2 id="confirmTitle">Confirm</h2>
        <div id="confirmTime"></div>
        <p id="confirmMessage"></p>
        <div style="display:flex;gap:.75rem;justify-content:flex-end;margin-top:1rem">
          <button id="confirmNo" class="btn">No</button>
          <button id="confirmYes" class="btn danger">Yes</button>
        </div>
      </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="../assets/js/supabaseClient.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/dataService.js"></script>
    <script src="../assets/js/ui.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/main.js"></script>

    <!-- Dark mode -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var btn = document.getElementById("darkModeToggle");
        var html = document.documentElement;
        function syncIcon() {
          var dark = html.getAttribute("data-theme") === "dark";
          btn.textContent = dark ? "â˜€ï¸" : "ğŸŒ™";
          btn.title = dark ? "Switch to light mode" : "Switch to dark mode";
        }
        syncIcon();
        btn.addEventListener("click", function () {
          var dark = html.getAttribute("data-theme") === "dark";
          if (dark) { html.removeAttribute("data-theme"); localStorage.setItem("theme","light"); }
          else { html.setAttribute("data-theme","dark"); localStorage.setItem("theme","dark"); }
          syncIcon();
        });
      });
    </script>



    <!-- MAIN CAROUSEL + DATA SCRIPT -->
    <script>
    document.addEventListener("DOMContentLoaded", async function () {

      /* â”€â”€ State â”€â”€ */
      let currentCard = 1; // 0=jobs, 1=weekly, 2=applied
      let allApps = [], allVacs = [], selectedVacId = null;

      const cards  = Array.from(document.querySelectorAll(".carousel-card"));
      const dots   = Array.from(document.querySelectorAll(".c-dot"));
      const panels = {
        0: document.getElementById("panel-jobs"),
        1: document.getElementById("panel-weekly"),
        2: document.getElementById("panel-applied"),
      };

      /* â”€â”€ Carousel logic â”€â”€ */
      function applyCarousel() {
        const n = cards.length;
        cards.forEach((card, i) => {
          card.classList.remove("cc-left", "cc-center", "cc-right");
          if      (i === currentCard)               card.classList.add("cc-center");
          else if (i === (currentCard - 1 + n) % n) card.classList.add("cc-left");
          else                                       card.classList.add("cc-right");
        });
        dots.forEach((d, i) => d.classList.toggle("active", i === currentCard));

        /* swap visible panel */
        Object.values(panels).forEach(p => p.classList.remove("active"));
        if (panels[currentCard]) panels[currentCard].classList.add("active");
      }

      document.getElementById("carouselPrev").addEventListener("click", function () {
        currentCard = (currentCard - 1 + cards.length) % cards.length;
        applyCarousel();
      });
      document.getElementById("carouselNext").addEventListener("click", function () {
        currentCard = (currentCard + 1) % cards.length;
        applyCarousel();
      });
      dots.forEach((d, i) => d.addEventListener("click", function () {
        currentCard = i; applyCarousel();
      }));

      /* clicking a SIDE card brings it to center â€” no navigation */
      cards.forEach(function (card) {
        card.addEventListener("click", function () {
          const idx = parseInt(card.dataset.index);
          if (idx !== currentCard) {
            currentCard = idx;
            applyCarousel();
          }
          /* center card click does nothing extra */
        });
      });

      /* swipe support */
      var touchStartX = 0;
      var stage = document.getElementById("cardStage");
      stage.addEventListener("touchstart", function (e) { touchStartX = e.touches[0].clientX; }, {passive:true});
      stage.addEventListener("touchend",   function (e) {
        var dx = e.changedTouches[0].clientX - touchStartX;
        if (Math.abs(dx) > 40) {
          currentCard = dx < 0
            ? (currentCard + 1) % cards.length
            : (currentCard - 1 + cards.length) % cards.length;
          applyCarousel();
        }
      });

      applyCarousel(); // init

      /* â”€â”€ Load all data â”€â”€ */
      async function loadAll() {
        allApps = await getAllApplications();
        allVacs = await getAllVacancies();
        updateStats();
        renderWeekly();
        renderApplied();
        renderJobs();
      }

      /* â”€â”€ Stats (card numbers) â”€â”€ */
      function updateStats() {
        const active = allApps.filter(a => a.status === "Active");
        document.getElementById("jobCount").textContent    = allVacs.length;
        document.getElementById("activeCount").textContent = active.length;

        var now = new Date(), weekEnd = new Date(now);
        weekEnd.setDate(now.getDate() + 7);
        var wc = 0;
        active.forEach(a => {
          if (!a.stages) return;
          a.stages.forEach(s => {
            if (!s.date) return;
            var dt = new Date(s.date + (s.time ? "T" + s.time : ""));
            if (dt >= now && dt <= weekEnd) wc++;
          });
        });
        document.getElementById("weeklyCount").textContent = wc;
      }

      /* â”€â”€ Weekly Schedule panel â”€â”€ */
      function renderWeekly() {
        var container = document.getElementById("upcomingContainer");
        if (!container) return;
        var now = new Date(), weekEnd = new Date(now);
        weekEnd.setDate(now.getDate() + 7);
        var active = allApps.filter(a => a.status === "Active");
        var evts = [];
        active.forEach(a => {
          if (!a.stages) return;
          a.stages.forEach(s => {
            if (!s.date) return;
            var dt = new Date(s.date + (s.time ? "T" + s.time : ""));
            if (dt >= now && dt <= weekEnd) evts.push({app:a, stage:s, dateTime:dt});
          });
        });
        evts.sort((a,b) => a.dateTime - b.dateTime);
        container.innerHTML = "";

        if (evts.length === 0) {
          var ph = document.createElement("div");
          ph.className = "no-events-msg";
          ph.textContent = "No events scheduled this week.";
          container.appendChild(ph);
          return;
        }

        evts.forEach(ev => {
          var ds   = ev.stage.date ? new Date(ev.stage.date).toLocaleDateString() : "-";
          var diff = Math.ceil((ev.dateTime - now) / 86400000);
          var tm   = ev.stage.time || "-";
          var card = document.createElement("div");
          card.className = "upcoming-card";
          card.dataset.id = ev.app.id;
          card.innerHTML = `
            <div class="ws-left">
              <div class="ws-company">${ev.app.company}</div>
              <div class="ws-activity">${ev.stage.name}</div>
              <div class="ws-date">${ds}</div>
            </div>
            <div class="ws-center">
              <div class="ws-status">Upcoming</div>
              <div class="ws-days">${diff} Day(s) left</div>
              <div class="ws-time">${tm}</div>
            </div>
            <div class="ws-right">
              <a href="application-detail.html?id=${ev.app.id}" class="detail-arrow-link" onclick="event.stopPropagation()">
                <span class="detail-arrow-icon"></span>
              </a>
            </div>`;
          card.addEventListener("click", () => window.location.href = "application-detail.html?id=" + ev.app.id);
          container.appendChild(card);
        });
      }

      /* â”€â”€ Active Application panel â”€â”€ */
      function renderApplied() {
        var body = document.getElementById("applicationsBody");
        if (!body) return;
        body.innerHTML = "";
        var apps = [...allApps].sort((x,y) => (x.priority||0)-(y.priority||0));

        if (apps.length === 0) {
          body.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#888;padding:1.5rem;">No applications yet. Click + Add to start.</td></tr>`;
          return;
        }

        apps.forEach(a => {
          var upText = "-";
          if (a.stages) {
            var now2 = new Date(), near = null, past = null;
            a.stages.forEach(s => {
              if (!s.date) return;
              var sd = new Date(s.date), diff = sd - now2;
              if (diff >= 0 && (!near || diff < near.diff)) near = {diff, stage:s};
              if (diff < 0  && (!past || sd > new Date(past.stage.date))) past = {stage:s};
            });
            if (near) upText = near.stage.name + " (" + new Date(near.stage.date).toLocaleDateString() + (near.stage.time ? ", " + near.stage.time : "") + ")";
            else if (past) upText = past.stage.name + " â€” sudah dijalani";
            else if (a.deadline) upText = "Deadline (" + new Date(a.deadline).toLocaleDateString() + ")";
          }

          var opts = ["Active","Rejected","Pending","Discontinued"];
          var status = a.status || "Pending";
          var jt = (a.jobTitle && a.jobTitle !== "-") ? a.jobTitle : "";

          var tr = document.createElement("tr");
          tr.dataset.id = a.id;
          tr.innerHTML = `
            <td><span class="priority-badge priority-${a.priority}" style="cursor:pointer;title='Change priority'">${status==="Active"?a.priority:"-"}</span></td>
            <td>${a.applyDate||"-"}</td>
            <td>${a.company}</td>
            <td>${a.program}</td>
            <td>${jt}</td>
            <td>
              <select class="status-select">
                ${opts.map(o=>`<option value="${o}"${o===status?" selected":""}>${o}</option>`).join("")}
              </select>
            </td>
            <td>${upText}</td>
            <td style="text-align:center">
              <a href="application-detail.html?id=${a.id}" class="detail-arrow-link" style="display:inline-block;text-decoration:none">
                <span class="detail-arrow-icon">â¤</span>
              </a>
            </td>`;

          tr.querySelector(".status-select").addEventListener("change", async function(e) {
            a.status = e.target.value;
            await updateApplication(a);
            await loadAll();
          });
          // Priority badge click
          var priBtn = tr.querySelector(".priority-badge");
          if (priBtn) {
            priBtn.addEventListener("click", function(e) {
              e.stopPropagation();
              if (status !== "Active") return;
              openPriorityModal("app", a);
            });
          }
          body.appendChild(tr);
        });

        setupFilter("appliedSearchInput", "applicationsBody", 2, "appliedSuggestions", apps.map(a=>a.company));
      }

      /* â”€â”€ Job Vacancy panel â”€â”€ */
      function renderJobs() {
        var body = document.getElementById("vacanciesBody");
        if (!body) return;
        body.innerHTML = "";
        var vacs = [...allVacs].sort((a,b)=>(a.priority??1e9)-(b.priority??1e9));

        if (vacs.length === 0) {
          body.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#888;padding:1.5rem;">No vacancies yet. Click + Add to start.</td></tr>`;
          return;
        }

        vacs.forEach(v => {
          var status = v.status || "Not Applied";
          var priDisp = status === "Applied" ? "-" : (v.priority ?? "-");
          var tr = document.createElement("tr");
          tr.dataset.id = v.id;
          tr.innerHTML = `
            <td><span class="priority-badge priority-${v.priority}" style="cursor:pointer">${priDisp}</span></td>
            <td>${v.company||"-"}</td>
            <td>${v.program||"-"}</td>
            <td>${v.jobTitle||"-"}</td>
            <td>${v.deadline?new Date(v.deadline).toLocaleDateString():"-"}</td>
            <td>
              <select class="vacancy-status-select">
                <option value="Applied"${status==="Applied"?" selected":""}>Applied</option>
                <option value="Not Applied"${status==="Not Applied"?" selected":""}>Not Applied</option>
              </select>
            </td>
            <td style="text-align:center">
              <a href="${v.link||"#"}" target="_blank" class="detail-arrow-link" style="display:inline-block;text-decoration:none">
                <span class="detail-arrow-icon">â¤</span>
              </a>
            </td>
            <td style="text-align:center">
              <span class="delete-row" style="cursor:pointer">ğŸ—‘ï¸</span>
            </td>`;

          tr.querySelector(".vacancy-status-select").addEventListener("change", async function(e) {
            v.status = e.target.value;
            if (v.status === "Applied") v.priority = null;
            else if (v.priority == null) v.priority = allVacs.reduce((m,x)=>Math.max(m,x.priority||0),0)+1;
            await saveVacanciesToServer(allVacs);
            await loadAll();
          });
          // Priority badge click
          var vacPriBtn = tr.querySelector(".priority-badge");
          if (vacPriBtn) {
            vacPriBtn.addEventListener("click", function(e) {
              e.stopPropagation();
              if (status === "Applied") return;
              openPriorityModal("vac", v);
            });
          }

          tr.querySelector(".delete-row").addEventListener("click", function(e) {
            e.stopPropagation();
            selectedVacId = v.id;
            document.getElementById("delJobCompany").textContent = "ğŸ¢ Company: " + v.company;
            document.getElementById("delJobProgram").textContent = "ğŸ·ï¸ Program: " + v.program;
            document.getElementById("delJobStage").textContent   = "ğŸ“ Position: " + v.jobTitle;
            document.getElementById("deleteJobModal").style.display = "flex";
          });

          body.appendChild(tr);
        });

        setupFilter("jobsSearchInput", "vacanciesBody", 1, "jobsSuggestions", vacs.map(v=>v.company));
      }

      /* â”€â”€ Search/filter helper â”€â”€ */
      function setupFilter(inputId, tbodyId, colIdx, dlId, names) {
        var inp = document.getElementById(inputId);
        var dl  = document.getElementById(dlId);
        if (!inp || !dl) return;
        dl.innerHTML = "";
        names.forEach(n => { var o = document.createElement("option"); o.value = n; dl.appendChild(o); });
        inp.oninput = function () {
          var term = inp.value.toLowerCase();
          var tbody = document.getElementById(tbodyId);
          if (!tbody) return;
          Array.from(tbody.children).forEach(row => {
            var cell = row.children[colIdx];
            var txt  = cell ? cell.textContent.toLowerCase() : "";
            row.style.display = txt.includes(term) ? "" : "none";
          });
        };
      }

      /* â”€â”€ Add Application â”€â”€ */
      document.getElementById("appliedAddBtn").addEventListener("click", () => document.getElementById("addAppModal").style.display = "flex");
      document.getElementById("closeAddApp").addEventListener("click",   () => document.getElementById("addAppModal").style.display = "none");
      document.getElementById("appModalSave").addEventListener("click", async function() {
        var co = document.getElementById("appModalCompany").value.trim();
        var pr = document.getElementById("appModalProgram").value.trim();
        var jt = document.getElementById("appModalJobTitle").value.trim();
        if (!co || !pr) { await showAlert("Please fill in Company and Program."); return; }
        var maxP = allApps.length ? Math.max(...allApps.map(d=>d.priority||0)) : 0;
        var newApp = { id: Date.now().toString(), company:co, program:pr, jobTitle:jt||"",
          applyDate: new Date().toLocaleDateString(), status:"Active", priority:maxP+1, stages:[] };
        await addApplication(newApp);
        document.getElementById("addAppModal").style.display = "none";
        ["appModalCompany","appModalProgram","appModalJobTitle"].forEach(id=>document.getElementById(id).value="");
        window.location.href = "application-detail.html?id=" + newApp.id;
      });

      /* â”€â”€ Add Vacancy â”€â”€ */
      document.getElementById("jobsAddBtn").addEventListener("click", () => document.getElementById("addJobModal").style.display = "flex");
      document.getElementById("closeAddJob").addEventListener("click",  () => document.getElementById("addJobModal").style.display = "none");
      document.getElementById("jobModalSave").addEventListener("click", async function() {
        var co = document.getElementById("jobModalCompany").value.trim();
        var pr = document.getElementById("jobModalProgram").value.trim();
        var jt = document.getElementById("jobModalJobTitle").value.trim();
        var dl = document.getElementById("jobModalDeadline").value;
        var lk = document.getElementById("jobModalLink").value.trim();
        if (!co || !pr || !lk) { await showAlert("Please fill Company, Program and Link."); return; }
        var fresh = await getAllVacancies();
        var newV = { id:Date.now().toString(), company:co, program:pr, jobTitle:jt||"-",
          deadline:dl||"", link:lk, status:"Not Applied", priority:fresh.length+1 };
        fresh.push(newV);
        await saveVacanciesToServer(fresh);
        document.getElementById("addJobModal").style.display = "none";
        ["jobModalCompany","jobModalProgram","jobModalJobTitle","jobModalDeadline","jobModalLink"].forEach(id=>document.getElementById(id).value="");
        await loadAll();
      });

      /* â”€â”€ Delete Vacancy â”€â”€ */
      document.getElementById("deleteJobConfirm").addEventListener("click", async function() {
        if (!selectedVacId) return;
        var fresh = await getAllVacancies();
        var idx = fresh.findIndex(v=>String(v.id)===String(selectedVacId));
        if (idx !== -1) fresh.splice(idx,1);
        await saveVacanciesToServer(fresh);
        document.getElementById("deleteJobModal").style.display = "none";
        selectedVacId = null;
        await loadAll();
      });
      document.getElementById("closeDeleteJob").addEventListener("click", () => document.getElementById("deleteJobModal").style.display = "none");

      /* Close modals on backdrop click */
      window.addEventListener("click", function(e) {
        if (e.target.id === "addAppModal")    document.getElementById("addAppModal").style.display    = "none";
        if (e.target.id === "addJobModal")    document.getElementById("addJobModal").style.display    = "none";
        if (e.target.id === "deleteJobModal") document.getElementById("deleteJobModal").style.display = "none";
      });

      /* â”€â”€ Priority Modal function â”€â”€ */
      function openPriorityModal(type, item) {
        var modal = document.getElementById("priorityModal");
        var optsDiv = document.getElementById("priorityOptions");
        if (!modal || !optsDiv) return;

        var list = (type === "app") ? allApps : allVacs;
        // eligible items (not Applied for vacancies)
        var eligible = list.filter(function(x) {
          return type === "app" ? true : x.status !== "Applied";
        });
        var maxPri = eligible.reduce(function(m,x){ return Math.max(m, x.priority||0); }, 0);
        maxPri = Math.max(maxPri, eligible.length);

        optsDiv.innerHTML = "";
        for (var p = 1; p <= maxPri; p++) {
          (function(pri) {
            var taken = eligible.find(function(x) { return x.id !== item.id && x.priority === pri; });
            var isCurrent = item.priority === pri;

            var btn = document.createElement("button");
            btn.className = "priority-option-btn" + (isCurrent ? " current" : "");

            var numSpan = document.createElement("span");
            numSpan.className = "pri-num";
            numSpan.textContent = pri;

            var labelSpan = document.createElement("span");
            if (isCurrent) {
              labelSpan.textContent = "Priority " + pri + " (current)";
            } else if (taken) {
              labelSpan.textContent = "Priority " + pri + " â€” swap with " + taken.company;
            } else {
              labelSpan.textContent = "Priority " + pri;
            }

            btn.appendChild(numSpan);
            btn.appendChild(labelSpan);

            if (!isCurrent) {
              btn.addEventListener("click", async function() {
                modal.style.display = "none";
                // Swap priorities
                if (taken) taken.priority = item.priority;
                item.priority = pri;
                if (type === "app") {
                  await saveApplicationsToServer(allApps);
                } else {
                  await saveVacanciesToServer(allVacs);
                }
                await loadAll();
              });
            }

            optsDiv.appendChild(btn);
          })(p);
        }

        modal.style.display = "flex";
      }

      // Close priority modal
      document.querySelector(".close-priority").addEventListener("click", function() {
        document.getElementById("priorityModal").style.display = "none";
      });
      window.addEventListener("click", function(e) {
        if (e.target.id === "priorityModal")
          document.getElementById("priorityModal").style.display = "none";
      });

      /* â”€â”€ Init & polling â”€â”€ */
      await loadAll();

      var lastA = JSON.stringify(allApps), lastV = JSON.stringify(allVacs);
      setInterval(async function() {
        var na = await getAllApplications();
        var nv = await getAllVacancies();
        var sa = JSON.stringify(na), sv = JSON.stringify(nv);
        if (sa !== lastA || sv !== lastV) {
          allApps = na; allVacs = nv; lastA = sa; lastV = sv;
          updateStats(); renderWeekly(); renderApplied(); renderJobs();
        }
      }, 10000);
    });
    </script>

  </body>
</html>
