<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Report a Bug â€” CareerTracker</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" />
  <link rel="stylesheet" href="../assets/css/base.css" />
  <link rel="stylesheet" href="../assets/css/layout.css" />
  <link rel="stylesheet" href="../assets/css/components.css" />
  <link rel="stylesheet" href="../assets/css/modal.css" />
  <link rel="stylesheet" href="../assets/css/mobile.css" />
  <link rel="stylesheet" href="../assets/css/theme.css" />
  <script>(function(){ if(localStorage.getItem('theme')==='dark') document.documentElement.setAttribute('data-theme','dark'); })();</script>
  <style>
    .page-content { padding: calc(var(--topbar-h) + 1.25rem) 1.5rem 3rem; max-width: 860px; margin: 0 auto; }
    .back-link { display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; color: var(--brand); font-weight: 600; text-decoration: none; margin-bottom: 1.25rem; }
    .page-header { margin-bottom: 1.5rem; }
    .page-header h1 { font-size: 1.5rem; font-weight: 800; color: var(--dark); }
    .page-header p { font-size: 0.85rem; color: var(--muted); margin-top: 0.3rem; }

    /* Steps guide */
    .guide-box { background: rgba(92,102,122,0.06); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.25rem 1.5rem; margin-bottom: 1.5rem; }
    .guide-box h4 { font-size: 0.82rem; font-weight: 700; color: var(--dark); margin-bottom: 0.75rem; }
    .guide-steps { display: flex; gap: 1rem; flex-wrap: wrap; }
    .guide-step { display: flex; align-items: flex-start; gap: 0.5rem; flex: 1; min-width: 160px; }
    .step-num { width: 22px; height: 22px; border-radius: 50%; background: var(--brand); color: white; font-size: 0.7rem; font-weight: 800; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .guide-step p { font-size: 0.78rem; color: var(--muted); line-height: 1.5; }

    /* Form card */
    .form-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 2rem; }
    .form-card-head { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); background: var(--card-bg); display: flex; align-items: center; gap: 0.5rem; }
    .form-card-head h3 { font-size: 0.95rem; font-weight: 700; color: var(--dark); }
    .form-body { padding: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-body .full { grid-column: 1 / -1; }
    .fgroup { display: flex; flex-direction: column; gap: 0.3rem; }
    .fgroup label { font-size: 0.7rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .fgroup input, .fgroup select, .fgroup textarea {
      padding: 0.65rem 1rem; border: 1.5px solid var(--border); border-radius: var(--radius-md);
      font-size: 0.88rem; font-family: "Poppins", sans-serif; color: var(--text); background: var(--surface);
      outline: none; transition: border-color 0.2s; width: 100%; box-sizing: border-box;
    }
    .fgroup input:focus, .fgroup select:focus, .fgroup textarea:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(92,102,122,0.1); }
    .fgroup textarea { resize: vertical; min-height: 120px; }
    .fgroup select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat:no-repeat; background-position:right 0.75rem center; background-size:1rem; padding-right:2.5rem; }
    .form-foot { padding: 1rem 1.5rem; border-top: 1px solid var(--border); background: var(--card-bg); display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .form-foot p { font-size: 0.78rem; color: var(--muted); }
    .btn-submit { padding: 0.65rem 1.75rem; background: var(--brand); color: white; border: none; border-radius: var(--radius-md); font-size: 0.88rem; font-weight: 700; font-family: "Poppins", sans-serif; cursor: pointer; transition: all 0.2s; }
    .btn-submit:hover { background: var(--brand-dark); }
    .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Reports list */
    .section-head { font-size: 1rem; font-weight: 700; color: var(--dark); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.6rem; }
    .section-head::after { content:""; flex:1; height:1px; background:var(--border); }
    .filter-bar { display: flex; gap: 0.6rem; margin-bottom: 1.25rem; flex-wrap: wrap; }
    .filt-btn { padding: 0.35rem 0.875rem; border-radius: 2rem; font-size: 0.78rem; font-weight: 600; border: 1.5px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; font-family: "Poppins", sans-serif; transition: all 0.2s; }
    .filt-btn.active, .filt-btn:hover { border-color: var(--brand); color: var(--brand); background: rgba(92,102,122,0.08); }
    .reports { display: flex; flex-direction: column; gap: 0.875rem; }
    .report-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.25rem 1.5rem; }
    .report-card:hover { box-shadow: var(--shadow-sm); }
    .report-top { display: flex; gap: 0.6rem; align-items: center; flex-wrap: wrap; margin-bottom: 0.5rem; }
    .report-title { font-size: 0.9rem; font-weight: 700; color: var(--dark); margin-bottom: 0.3rem; }
    .report-desc { font-size: 0.82rem; color: var(--muted); line-height: 1.6; }
    .report-meta { font-size: 0.72rem; color: var(--muted); margin-top: 0.5rem; display: flex; gap: 1rem; flex-wrap: wrap; }
    .badge { padding: 0.18rem 0.65rem; border-radius: 2rem; font-size: 0.7rem; font-weight: 700; }
    .sev-low { background:rgba(34,197,94,0.1); color:#15803d; border:1px solid rgba(34,197,94,0.2); }
    .sev-medium { background:rgba(245,158,11,0.12); color:#d97706; border:1px solid rgba(245,158,11,0.25); }
    .sev-high { background:rgba(239,68,68,0.1); color:#dc2626; border:1px solid rgba(239,68,68,0.2); }
    .sev-critical { background:rgba(124,0,0,0.1); color:#7c0000; border:1px solid rgba(124,0,0,0.2); }
    .stat-open { background:rgba(59,130,246,0.1); color:#2563eb; border:1px solid rgba(59,130,246,0.2); }
    .stat-in-progress { background:rgba(245,158,11,0.1); color:#d97706; border:1px solid rgba(245,158,11,0.2); }
    .stat-resolved { background:rgba(34,197,94,0.1); color:#15803d; border:1px solid rgba(34,197,94,0.2); }
    .stat-closed { background:rgba(156,163,175,0.12); color:var(--muted); border:1px solid var(--border); }
    .admin-note { margin-top:0.75rem; padding:0.6rem 0.875rem; background:rgba(244,185,96,0.07); border:1px solid rgba(244,185,96,0.2); border-radius:var(--radius-sm); font-size:0.78rem; color:var(--text); }
    .admin-controls { display:flex; gap:0.5rem; margin-top:0.75rem; flex-wrap:wrap; }
    .admin-sel { padding:0.3rem 0.6rem; border:1px solid var(--border); border-radius:var(--radius-sm); font-size:0.75rem; background:var(--surface); color:var(--text); font-family:"Poppins",sans-serif; cursor:pointer; }
    .admin-note-input { flex:1; padding:0.3rem 0.6rem; border:1px solid var(--border); border-radius:var(--radius-sm); font-size:0.75rem; background:var(--surface); color:var(--text); font-family:"Poppins",sans-serif; min-width:150px; }
    .empty-state { text-align:center; padding:3rem 1rem; color:var(--muted); }
    .empty-icon { font-size:2.5rem; margin-bottom:0.75rem; }

    @media (max-width: 600px) { .form-body { grid-template-columns: 1fr; } .guide-steps { flex-direction:column; } }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="left-section">
      <div id="toggleBtn">â˜°</div>
      <a href="home.html" class="logo">Career<span>Tracker</span></a>
    </div>
    <div class="right-section">
      <button class="lang-btn" title="Switch language">ğŸ‡¬ğŸ‡§ EN</button>
      <button id="darkModeToggle" title="Toggle dark mode">ğŸŒ™</button>
      <div class="profile" id="profileBtn">
        <span id="topbarDisplayName">-</span>
        <div class="avatar" id="topbarAvatar"></div>
      </div>
    </div>
  </header>
  <aside class="sidebar" id="sidebar">
    <div class="menu">
      <a href="home.html" class="menu-item">ğŸ  <span data-i18n="nav_home">Home</span></a>
      <a href="how-to-use.html" class="menu-item">ğŸ“– <span data-i18n="nav_how_to_use">How to Use</span></a>
      <a href="about.html" class="menu-item active">â„¹ï¸ <span data-i18n="nav_about">About</span></a>        <div id="adminMenu" style="display:none">
          <div class="admin-menu-label">Admin Panel</div>
          <a href="contact-email.html"   class="menu-item admin-item">âœ‰ï¸ <span>Messages</span></a>
          <a href="contact-bug.html"     class="menu-item admin-item">ğŸ› <span>Bug Reports</span></a>
          <a href="contact-feature.html" class="menu-item admin-item">ğŸ’¡ <span>Feature Requests</span></a>
        </div>
      </div>
  </aside>
  <div id="sidebarOverlay"></div>
  <div class="profile-dropdown" id="dropdown">
    <div data-i18n="nav_profile">ğŸ‘¤ Profile</div>
    <div id="cvLink" data-i18n="nav_my_cv">ğŸ“„ My CV</div>
    <div id="contactLink" data-i18n="nav_contact">ğŸ’¬ Contact Us</div>
    <hr />
    <div class="logout" data-i18n="nav_sign_out">ğŸšª Sign Out</div>
  </div>

  <main class="main" id="main">
    <div class="page-content">
      <a href="about.html" class="back-link">â† <span data-i18n="nav_about">About</span></a>
      <div class="page-header">
        <h1>ğŸ› <span data-i18n="bug_title">Laporkan Bug</span></h1>
        <p data-i18n="bug_subtitle">Menemukan masalah? Bantu kami memperbaikinya dengan laporan yang detail.</p>
      </div>

      <div class="guide-box">
        <h4>ğŸ“‹ <span data-i18n="bug_guide_title">Cara membuat laporan bug yang baik</span></h4>
        <div class="guide-steps">
          <div class="guide-step"><div class="step-num">1</div><p data-i18n="bug_guide_1">Jelaskan apa yang <strong>seharusnya</strong> terjadi</p></div>
          <div class="guide-step"><div class="step-num">2</div><p data-i18n="bug_guide_2">Jelaskan apa yang <strong>sebenarnya</strong> terjadi</p></div>
          <div class="guide-step"><div class="step-num">3</div><p data-i18n="bug_guide_3">Tulis <strong>langkah-langkah</strong> untuk mereproduksinya</p></div>
          <div class="guide-step"><div class="step-num">4</div><p data-i18n="bug_guide_4">Catat <strong>halaman/fitur</strong> yang terpengaruh</p></div>
        </div>
      </div>

      <!-- Submit Form -->
      <div class="form-card">
        <div class="form-card-head">
          <span>ğŸ›</span>
          <h3 data-i18n="bug_form_title">Kirim Laporan Bug</h3>
        </div>
        <div class="form-body">
          <div class="fgroup full">
            <label>Bug Title *</label>
            <input type="text" id="bugTitle" placeholder="Deskripsi singkat dan jelas tentang masalah" />
          </div>
          <div class="fgroup">
            <label>Severity *</label>
            <select id="bugSeverity">
              <option value="low">ğŸŸ¢ Low â€” Minor annoyance</option>
              <option value="medium" selected>ğŸŸ¡ Medium â€” Affects workflow</option>
              <option value="high">ğŸ”´ High â€” Blocks usage</option>
              <option value="critical">ğŸš¨ Critical â€” Crash / data loss</option>
            </select>
          </div>
          <div class="fgroup">
            <label>Category *</label>
            <select id="bugCategory">
              <option value="ui">ğŸ¨ UI / Visual</option>
              <option value="functionality" selected>âš™ï¸ Functionality</option>
              <option value="performance">âš¡ Performance</option>
              <option value="data">ğŸ’¾ Data / Sync</option>
              <option value="other">ğŸ“¦ Other</option>
            </select>
          </div>
          <div class="fgroup full">
            <label>Page / Feature Affected</label>
            <input type="text" id="bugPage" placeholder="contoh: Beranda, Detail Lamaran, Editor CV..." />
          </div>
          <div class="fgroup full">
            <label>Detailed Description *</label>
            <textarea id="bugDesc" placeholder="Langkah reproduksi, perilaku yang diharapkan vs aktual, pesan error..."></textarea>
          </div>
        </div>
        <div class="form-foot">
          <p data-i18n="bug_form_note">Username Anda akan dilampirkan untuk tindak lanjut.</p>
          <button class="btn-submit" id="submitBugBtn" data-i18n="bug_submit_btn">ğŸ› Kirim Laporan</button>
        </div>
      </div>

      <!-- Reports List -->
      <div class="section-head">ğŸ“‹ All Bug Reports</div>
      <div class="filter-bar">
        <button class="filt-btn active" data-filter="all" data-i18n="filter_all">Semua</button>
        <button class="filt-btn" data-filter="open" data-i18n="filter_open">Terbuka</button>
        <button class="filt-btn" data-filter="in-progress" data-i18n="filter_progress">Diproses</button>
        <button class="filt-btn" data-filter="resolved" data-i18n="filter_resolved">Selesai</button>
        <button class="filt-btn" data-filter="critical">ğŸš¨ Critical</button>
      </div>
      <div class="reports" id="reportsList">
        <div class="empty-state"><div class="empty-icon">ğŸ“­</div><p data-i18n="loading">Memuat...</p></div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="../assets/js/darkMode.js"></script>
  <script src="../assets/js/supabaseClient.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/ui.js"></script>
  <script src="../assets/js/i18n.js"></script>
  <script src="../assets/js/main.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const db = window.supabaseClient;
      const username = localStorage.getItem("currentUser");
      const isAdmin = username === "admin";
      let activeFilter = "all";

      function escHtml(s) { return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
      function sevClass(s) { return "badge sev-"+s; }
      function statClass(s) { return "badge stat-"+s.replace("-","-"); }
      function sevLabel(s) { return {low:"ğŸŸ¢ Low",medium:"ğŸŸ¡ Medium",high:"ğŸ”´ High",critical:"ğŸš¨ Critical"}[s]||s; }
      function catLabel(c) { return {ui:"ğŸ¨ UI",functionality:"âš™ï¸ Functionality",performance:"âš¡ Performance",data:"ğŸ’¾ Data",other:"ğŸ“¦ Other"}[c]||c; }
      function statLabel(s) { return {open:"Open","in-progress":"In Progress",resolved:"Resolved âœ…",closed:"Closed"}[s]||s; }
      function fmtDate(d) { return new Date(d).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}); }

      async function loadReports() {
        const { data, error } = await db.from("bug_reports").select("*").order("created_at",{ascending:false});
        const el = document.getElementById("reportsList");
        if (error) {
          const isRLS = error.message && (error.message.includes("permission") || error.message.includes("denied") || error.message.includes("policy"));
          el.innerHTML = isRLS && isAdmin
            ? '<div class="empty-state"><div class="empty-icon">âš ï¸</div><p>Supabase RLS aktif.<br><small>Tambahkan policy untuk admin di tabel bug_reports.</small></p></div>'
            : '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>Belum ada laporan bug.</p></div>';
          return;
        }
        let items = data || [];
        if (activeFilter === "critical") items = items.filter(r => r.severity === "critical");
        else if (activeFilter !== "all") items = items.filter(r => r.status === activeFilter);
        if (items.length === 0) {
          el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>No reports match this filter.</p></div>';
          return;
        }
        el.innerHTML = items.map(r => `
          <div class="report-card">
            <div class="report-top">
              <span class="${sevClass(r.severity)}">${sevLabel(r.severity)}</span>
              <span class="${statClass(r.status)}">${statLabel(r.status)}</span>
              <span class="badge" style="background:var(--card-bg);border:1px solid var(--border);color:var(--muted)">${catLabel(r.category)}</span>
            </div>
            <div class="report-title">${escHtml(r.title)}</div>
            <div class="report-desc">${escHtml(r.description)}</div>
            <div class="report-meta">
              <span>ğŸ‘¤ ${isAdmin ? escHtml(r.reporter_username) : (r.reporter_username===username?"You":escHtml(r.reporter_username))}</span>
              ${r.page_url?`<span>ğŸ“„ ${escHtml(r.page_url)}</span>`:""}
              <span>ğŸ—“ ${fmtDate(r.created_at)}</span>
            </div>
            ${r.admin_notes?`<div class="admin-note">ğŸ‘‘ Admin: ${escHtml(r.admin_notes)}</div>`:""}
            ${isAdmin ? `
            <div class="admin-controls">
              <select class="admin-sel" onchange="updateStatus('${r.id}',this.value)">
                <option value="open"${r.status==="open"?" selected":""}>Open</option>
                <option value="in-progress"${r.status==="in-progress"?" selected":""}>In Progress</option>
                <option value="resolved"${r.status==="resolved"?" selected":""}>Resolved</option>
                <option value="closed"${r.status==="closed"?" selected":""}>Closed</option>
              </select>
              <input class="admin-note-input" type="text" value="${escHtml(r.admin_notes||"")}" placeholder="Add admin note..." onblur="saveNote('${r.id}',this.value)" />
            </div>` : ""}
          </div>`).join("");
      }

      window.updateStatus = async (id, status) => {
        await db.from("bug_reports").update({status, updated_at: new Date().toISOString()}).eq("id",id);
        await loadReports();
      };
      window.saveNote = async (id, note) => {
        await db.from("bug_reports").update({admin_notes: note, updated_at: new Date().toISOString()}).eq("id",id);
      };

      // Submit
      document.getElementById("submitBugBtn").addEventListener("click", async () => {
        const title = document.getElementById("bugTitle").value.trim();
        const desc = document.getElementById("bugDesc").value.trim();
        const severity = document.getElementById("bugSeverity").value;
        const category = document.getElementById("bugCategory").value;
        const page = document.getElementById("bugPage").value.trim();
        if (!title || !desc) { showAlert("Please fill in the title and description."); return; }
        const btn = document.getElementById("submitBugBtn");
        btn.disabled = true; btn.textContent = "Submitting...";
        const { error } = await db.from("bug_reports").insert({ reporter_username: username, title, description: desc, severity, category, page_url: page||null });
        btn.disabled = false; btn.textContent = "ğŸ› Submit Report";
        if (error) { showAlert("Failed: " + error.message); return; }
        showAlert("Bug report submitted! âœ… Thank you.");
        document.getElementById("bugTitle").value = "";
        document.getElementById("bugDesc").value = "";
        document.getElementById("bugPage").value = "";
        document.getElementById("bugSeverity").value = "medium";
        document.getElementById("bugCategory").value = "functionality";
        await loadReports();
      });

      // Filters
      document.querySelectorAll(".filt-btn").forEach(b => {
        b.addEventListener("click", () => {
          document.querySelectorAll(".filt-btn").forEach(x => x.classList.remove("active"));
          b.classList.add("active");
          activeFilter = b.dataset.filter;
          loadReports();
        });
      });

      await loadReports();
    });
  </script>
</body>
</html>
